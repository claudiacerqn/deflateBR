#' Deflate Brazilian Reais in Nominal Values Using IPCA
#'
#' @description
#' \code{ipca} uses data from the Brazilian Institute of Geography and Statistics (IBGE) to deflate
#' Brazilian Reais nominal values using the IPCA to current values. As of now, the \code{ipca} deflate
#' values by month
#'
#' @param data A \code{data.frame} or \code{tibble} containing nominal Reais and their original dates;
#' @param values A vector containing nominal Brazilian Reais to deflate;
#' @param actual_date A vector of class \code{Date} containing the nominal values' original dates;
#' @param ref_date An object of class \code{Date} indicating the reference date to deflate nominal values
#' (e.g., 2018-01-01 for January 2018).
#' @param outname A \code{character} specifying the name of the output variable with current Reais.
#'
#' @details The data used to deflate nominal values comes from the IBGE's Sidra, convering the period
#' from December 1979 up to now.
#'
#' @references For more information on the IBGE's data, please check (in Portuguese):
#' \url{https://sidra.ibge.gov.br/pesquisa/snipc}.
#'
#' @return A \code{numeric} vector of current Brazilian Reais.
#'
#' @examples
#' \dontrun{
#' # Use IPCA to deflate a vector of nominal Brazilian Reais
#' reais <- rep(100, 5)
#' actual_dates <- seq.Date(from = as.Date("2001-01-01"), to = as.Date("2001-05-01"), by = "month")
#'
#' ipca(reais, actual_dates, as.Date("2018-01-01"))
#' }
#'
#' @importFrom rlang .data
#' @importFrom rlang :=
#' @importFrom dplyr %>%
#' @import lubridate
#' @import readxl
#' @import rlang
#' @import utils
#'
#' @export

ipca <- function(data, values, actual_date, ref_date, outname = "def_values"){


  # Inputs
  actual_date_var <- rlang::enquo(actual_date)
  values_var <- rlang::enquo(values)

  # Get IPCA data
  message("\nDownloading necessary data from IBGE's Sidra.\n...\n")
  tmp <- tempfile()

     "https://sidra.ibge.gov.br/geratabela?format=xlsx&name=tabela1737.xlsx&terr=N&rank=-&query=t/1737/n1/all/v/2266/p/all/d/v2266%2013/l/v,,p%2Bt" %>%
      utils::download.file(tmp, mode = "wb")

  ipca <- readxl::read_excel(tmp, skip = 3, col_names = c("mes", "brasil", "indx")) %>%
    dplyr::select(-2) %>%
    dplyr::slice(-dplyr::n()) %>%
    dplyr::mutate(mes = seq.Date(from = as.Date("1979-12-01"), by = "month", length.out = dplyr::n())) %>%
    dplyr::mutate(indx = .data$indx[.data$mes == ref_date] / .data$indx) %>%
    dplyr::filter(.data$indx >= 1)

  unlink(tmp)


  # Deflate series
  data %>%
    dplyr::mutate(actual_date = lubridate::floor_date(!!actual_date_var, unit = "month")) %>%
    dplyr::mutate(!!outname := !!values_var * ipca$indx[match(!!actual_date_var, ipca$mes)])
}




